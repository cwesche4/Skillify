// ------------------------------
// PRISMA 7 GENERATOR
// ------------------------------
generator client {
  provider = "prisma-client-js"
}

// ------------------------------
// PRISMA 7 DATASOURCE (NO URL HERE)
// URL comes from prisma.config.mjs
// ------------------------------
datasource db {
  provider = "postgresql"
}

//
// ENUMS
//

enum WorkspaceMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum AutomationStatus {
  INACTIVE
  ACTIVE
  PAUSED
  ARCHIVED
}

enum RunStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

//
// CORE USER
//

model UserProfile {
  id      String @id @default(cuid())
  clerkId String @unique
  role    String @default("user")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Onboarding progress
  onboardingProgress OnboardingProgress?

  // Relations
  automations     Automation[]
  runs            AutomationRun[]
  subscription    Subscription?
  memberships     WorkspaceMember[]
  ownedWorkspaces Workspace[]       @relation("WorkspaceOwner")

  @@index([clerkId])
}

//
// ONBOARDING PROGRESS
//

model OnboardingProgress {
  id        String   @id @default(cuid())
  userId    String   @unique
  steps     String[]
  completed Boolean  @default(false)
  updatedAt DateTime @updatedAt

  user UserProfile @relation(fields: [userId], references: [id])
}

//
// WORKSPACES
//

model Workspace {
  id   String @id @default(cuid())
  name String
  slug String @unique

  ownerId String
  owner   UserProfile @relation("WorkspaceOwner", fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  automations Automation[]
  runs        AutomationRun[]
  invites     WorkspaceInvite[]

  @@index([ownerId])
  @@index([slug])
}

//
// WORKSPACE MEMBERS
//

model WorkspaceMember {
  id          String              @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceMemberRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      UserProfile @relation(fields: [userId], references: [id])
  workspace Workspace   @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
}

//
// WORKSPACE INVITES
//

model WorkspaceInvite {
  id          String              @id @default(cuid())
  workspaceId String
  email       String
  role        WorkspaceMemberRole @default(MEMBER)

  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([email])
}

//
// AUTOMATIONS
//

model Automation {
  id String @id @default(cuid())

  userId      String
  workspaceId String

  name        String
  description String?
  status      AutomationStatus @default(INACTIVE)

  flow Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      UserProfile @relation(fields: [userId], references: [id])
  workspace Workspace   @relation(fields: [workspaceId], references: [id])

  runs AutomationRun[]
}

model AutomationRun {
  id           String @id @default(cuid())
  automationId String
  workspaceId  String

  status     RunStatus
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  log        String?

  automation    Automation   @relation(fields: [automationId], references: [id])
  workspace     Workspace    @relation(fields: [workspaceId], references: [id])
  userProfile   UserProfile? @relation(fields: [userProfileId], references: [id])
  userProfileId String?

  events AutomationRunEvent[]

  @@index([workspaceId])
  @@index([automationId])
}

model AutomationRunEvent {
  id        String    @id @default(cuid())
  runId     String
  nodeId    String
  nodeType  String
  status    RunStatus
  message   String?
  path      String?
  createdAt DateTime  @default(now())

  run AutomationRun @relation(fields: [runId], references: [id])

  @@index([runId])
  @@index([nodeId])
  @@index([nodeType])
  @@index([status])
}

//
// BILLING
//

model Subscription {
  id     String      @id @default(cuid())
  userId String      @unique
  user   UserProfile @relation(fields: [userId], references: [id])

  stripeCustomerId String?
  stripeSubId      String?

  plan   String
  status String

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
